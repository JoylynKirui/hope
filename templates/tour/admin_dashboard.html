{% extends "base_dashboard.html" %}
{% block content %}
<div class="container">
  <h1>Admin Dashboard</h1>

  <form method="get" class="mb-3">
    <input type="text" name="q" placeholder="Search planners..." value="{{ q }}">
    <button type="submit">Search</button>
  </form>

  <table class="table table-striped">
    <thead>
      <tr>
        <th>Planner</th>
        <th>Email</th>
        <th>Company</th>
        <th>Latest Subscription</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for profile in profiles %}
        {% with latest=profile.subscriptions.first %}
        <tr>
          <td>{{ profile.user.username }}</td>
          <td>{{ profile.user.email }}</td>
          <td>{{ profile.company_name }}</td>
          <td>
            {% if latest %}
              {{ latest.plan }} ({{ latest.start_date }} - {{ latest.end_date }})
            {% else %}
              None
            {% endif %}
          </td>
          <td>
            {% if latest %}
              {{ latest.status }}
            {% else %}
              No subscription
            {% endif %}
          </td>
          <td>
            <a href="{% url 'admin_planner_detail' profile.id %}">View</a>
            {% if latest %}
              | <a href="{% url 'admin_subscription_edit' latest.id %}">Edit</a>
              | <form action="{% url 'admin_subscription_toggle' latest.id %}" method="post" style="display:inline;">
                  {% csrf_token %}
                  <button type="submit">Toggle</button>
                </form>
            {% endif %}
          </td>
        </tr>
        {% endwith %}
      {% endfor %}
    </tbody>
  </table>

  <div class="pagination">
    {% if profiles.has_previous %}
      <a href="?page={{ profiles.previous_page_number }}&q={{ q }}">Previous</a>
    {% endif %}
    <span>Page {{ profiles.number }} of {{ profiles.paginator.num_pages }}</span>
    {% if profiles.has_next %}
      <a href="?page={{ profiles.next_page_number }}&q={{ q }}">Next</a>
    {% endif %}
  </div>
</div>
{% endblock %}
